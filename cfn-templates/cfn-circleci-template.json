{  
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"CircleCI template",
  "Resources":{  
    "CircleUser":{  
      "Type":"AWS::IAM::User",
      "Properties":{  
        "Path":"/"
      }
    },
    "CircleAccessKey":{  
      "Type":"AWS::IAM::AccessKey",
      "Properties":{  
        "Status":"Active",
        "UserName":{  
          "Ref":"CircleUser"
        }
      }
    },
    "CircleS3Bucket":{  
      "Type":"AWS::S3::Bucket",
      "Properties":{  
        "AccessControl":"Private",
        "BucketName":"circle-releases",
        "Tags":[  
          {  
            "Key":"Name",
            "Value":"Circle"
          },
          {  
            "Key":"Type",
            "Value":"releases"
          }
        ]
      },
      "DeletionPolicy":"Delete"
    },
    "CircleS3Policy":{  
      "Type":"AWS::IAM::Policy",
      "Properties":{  
        "PolicyDocument":{  
          "Version":"2012-10-17",
          "Statement":[  
            {  
              "Effect":"Allow",
              "Action":[  
                "s3:PutObject"
              ],
              "Resource":[  
                {  
                  "Fn::Join":[  
                    "",
                    [  
                      "arn:aws:s3:::",
                      {  
                        "Ref":"CircleS3Bucket"
                      },
                      "/hello-circle*"
                    ]
                  ]
                }
              ]
            }
          ]
        },
        "Users":[  
          {  
            "Ref":"CircleUser"
          }
        ],
        "PolicyName":"CircleS3Policy"
      },
      "DependsOn":"CircleUser"
    },
    "CircleCodeDeployPolicy":{  
      "Type":"AWS::IAM::Policy",
      "Properties":{  
        "PolicyDocument":{  
          "Version":"2012-10-17",
          "Statement":[  
            {  
              "Effect":"Allow",
              "Action":[  
                "codedeploy:RegisterApplicationRevision",
                "codedeploy:GetApplicationRevision"
              ],
              "Resource":[  
                {  
                  "Fn::Join":[  
                    "",
                    [  
                      "arn:aws:codedeploy",
                      ":us-west-2:",
                      {  
                        "Ref":"AWS::AccountId"
                      },
                      ":application",
                      ":hello-circleci"
                    ]
                  ]
                }
              ]
            },
            {  
              "Effect":"Allow",
              "Action":[  
                "codedeploy:CreateDeployment",
                "codedeploy:GetDeployment"
              ],
              "Resource":[  
                {  
                  "Fn::Join":[  
                    "",
                    [  
                      "arn:aws:codedeploy",
                      ":us-west-2:",
                      {  
                        "Ref":"AWS::AccountId"
                      },
                      ":deploymentgroup",
                      ":hello-circleci/*"
                    ]
                  ]
                }
              ]
            },
            {  
              "Effect":"Allow",
              "Action":[  
                "codedeploy:GetDeploymentConfig"
              ],
              "Resource":[  
                {  
                  "Fn::Join":[  
                    "",
                    [  
                      "arn:aws:codedeploy",
                      ":us-west-2:",
                      {  
                        "Ref":"AWS::AccountId"
                      },
                      ":deploymentconfig",
                      ":CodeDeployDefault.OneAtATime"
                    ]
                  ]
                }
              ]
            }
          ]
        },
        "Users":[  
          {  
            "Ref":"CircleUser"
          }
        ],
        "PolicyName":"CircleCodeDeployPolicy"
      }
    }
  },
    "Outputs" : {
  "SecretKey" : {
    "Description" : "Secret Key Circle User",
    "Value" : { "Fn::GetAtt" : ["CircleAccessKey", "SecretAccessKey"] }
  },
  "AccessKey" : {
     "Description" : "Access Key Circle User",
      "Value" : { "Ref" : "CircleAccessKey" }
  }
    }
}